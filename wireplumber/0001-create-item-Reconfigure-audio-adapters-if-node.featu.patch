From e761c89c10daf878bc3e7dcc4be0affd6c235b52 Mon Sep 17 00:00:00 2001
From: Julian Bouzas <julian.bouzas@collabora.com>
Date: Thu, 3 Jul 2025 10:39:02 -0400
Subject: [PATCH 1/3] create-item: Reconfigure audio adapters if
 'node.features.audio.*' settings changed

Up until now, all the 'node.features.audio.*' settings did not have any effect
if changed at runtime. This patch fixes this by reconfiguring the audio adapters
every time those settings have changed.
---
 src/scripts/node/create-item.lua | 48 ++++++++++++++++++++++++++++++++
 1 file changed, 48 insertions(+)

diff --git a/src/scripts/node/create-item.lua b/src/scripts/node/create-item.lua
index 813f238b..30547f62 100644
--- a/src/scripts/node/create-item.lua
+++ b/src/scripts/node/create-item.lua
@@ -152,3 +152,51 @@ SimpleEventHook {
 
   end
 }:register ()
+
+function reconfigureAudioAdapters ()
+  source = source or Plugin.find ("standard-event-source")
+  local nodes_om = source:call ("get-object-manager", "node")
+  local node_ids = {}
+
+  log:info ("Reconfiguring audio adapters")
+
+  -- Get the Id of all session items that are audio adapters
+  for id, item in pairs(items) do
+    local si_props = item.properties
+    if si_props ["item.factory.name"] == "si-audio-adapter" then
+      table.insert (node_ids, id)
+    end
+  end
+
+  -- Remove the audio adapter items so they are unlinked
+  for _, id in pairs (node_ids) do
+    local node = nodes_om:lookup {
+      Constraint { "id", "=", id, type = "gobject" },
+    }
+    if node ~= nil then
+      source:call ("push-event", "removed", node, nil)
+    end
+  end
+
+  -- Add back the audio adapter items so they are reconfigured and linked
+  for _, id in pairs (node_ids) do
+    local node = nodes_om:lookup {
+      Constraint { "id", "=", id, type = "gobject" },
+    }
+    if node ~= nil then
+      source:call ("push-event", "added", node, nil)
+    end
+  end
+end
+
+Settings.subscribe ("node.features.audio.no-dsp", function ()
+  reconfigureAudioAdapters ()
+end)
+
+Settings.subscribe ("node.features.audio.monitor-ports", function ()
+  reconfigureAudioAdapters ()
+end)
+
+Settings.subscribe ("node.features.audio.control-port", function ()
+  reconfigureAudioAdapters ()
+end)
-- 
2.50.1

